<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <title>Open Blagnac - Cadastre 3D</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    
    <script src='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js'></script>
    <link href='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css' rel='stylesheet' />
    
    <script src="https://unpkg.com/pmtiles@2.11.0/js/index.js"></script>

    <style>
        body { margin: 0; padding: 0; display: flex; height: 100vh; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        /* SIDEBAR (Barre lat√©rale) */
        #sidebar {
            width: 300px; background: #fff; box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            z-index: 10; display: flex; flex-direction: column;
        }
        .header { background: #0F172A; color: white; padding: 20px; }
        .header h1 { margin: 0; font-size: 1.2rem; font-weight: 700; }
        .subtitle { font-size: 0.8rem; opacity: 0.7; }
        
        .content { flex: 1; padding: 20px; overflow-y: auto; }
        
        /* Boutons de contr√¥le des couches */
        .layer-toggle {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px; background: #f8fafc; border: 1px solid #e2e8f0;
            border-radius: 6px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s;
        }
        .layer-toggle:hover { border-color: #3b82f6; }
        .layer-toggle.active { background: #eff6ff; border-color: #3b82f6; }
        .layer-label { font-weight: 600; font-size: 0.9rem; color: #334155; }
        
        /* CARTE */
        #map { flex: 1; }

        /* POPUP */
        .maplibregl-popup-content { padding: 15px; border-radius: 8px; font-size: 14px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="header">
        <h1>OPEN BLAGNAC</h1>
        <div class="subtitle">Cadastre & B√¢timents 3D</div>
    </div>
    <div class="content">
        <p style="font-size: 0.85rem; color: #64748b; margin-bottom: 20px;">
            Les donn√©es ci-dessous proviennent de votre fichier <code>blagnac.pmtiles</code> h√©berg√© sur GitHub.
        </p>

        <div class="layer-toggle active" id="btn-batiments" onclick="toggleLayer('batiments-3d', 'btn-batiments')">
            <span class="layer-label">üè¢ B√¢timents (Extrusion)</span>
            <input type="checkbox" checked>
        </div>

        <div class="layer-toggle active" id="btn-parcelles" onclick="toggleLayer('parcelles-lines', 'btn-parcelles')">
            <span class="layer-label">üìê Cadastre (Lignes)</span>
            <input type="checkbox" checked>
        </div>
    </div>
</div>

<div id="map"></div>

<script>
    // ----------------------------------------------------------------
    // 1. INITIALISATION DU PROTOCOLE PMTILES
    // ----------------------------------------------------------------
    let protocol = new pmtiles.Protocol();
    maplibregl.addProtocol("pmtiles", protocol.tile);

    // ----------------------------------------------------------------
    // 2. CR√âATION DE LA CARTE
    // ----------------------------------------------------------------
    const map = new maplibregl.Map({
        container: 'map',
        // Fond de carte gris neutre (gratuit via MapTiler Basic)
        style: 'https://api.maptiler.com/maps/basic-v2/style.json?key=get_your_own_OpIi9ZULNHzrESv6T2vL', 
        center: [1.392, 43.636], // Centr√© sur Blagnac
        zoom: 15,
        pitch: 60, // Inclinaison 3D prononc√©e
        bearing: -10, // L√©g√®re rotation
        hash: true // Affiche la position dans l'URL
    });

    map.addControl(new maplibregl.NavigationControl({ visualizePitch: true }));

    // ----------------------------------------------------------------
    // 3. CHARGEMENT DES DONN√âES
    // ----------------------------------------------------------------
    map.on('load', () => {
        
        // --- SOURCE PRINCIPALE (Votre fichier PMTiles) ---
        // Remplacez 'Bjonat' par votre pseudo exact s'il est diff√©rent (casse respect√©e)
        const pmtilesUrl = "https://bjonat.github.io/Open-blagnac/data/blagnac.pmtiles";

        map.addSource('source_blagnac', {
            type: "vector",
            url: "pmtiles://" + pmtilesUrl
        });

        // --- COUCHE 1 : LES PARCELLES (Lignes bleues) ---
        map.addLayer({
            "id": "parcelles-lines",
            "source": "source_blagnac",
            "source-layer": "cadastre", // Nom d√©fini lors de la commande tippecanoe (-l cadastre)
            "type": "line",
            "paint": {
                "line-color": "#2563eb", // Bleu vif
                "line-width": 1,
                "line-opacity": 0.6
            }
        });

        // --- COUCHE 2 : LES B√ÇTIMENTS (Volume 3D) ---
        // Note : Comme tout est dans la m√™me couche "cadastre", on applique une extrusion
        // Si les parcelles s'extrudent aussi, nous devrons affiner le filtre.
        map.addLayer({
            "id": "batiments-3d",
            "source": "source_blagnac",
            "source-layer": "cadastre",
            "type": "fill-extrusion",
            // Filtre : On essaie d'exclure les parcelles si possible. 
            // Souvent, les parcelles n'ont pas de nom, alors que les sections ou autres oui.
            // Pour l'instant, on affiche tout en 3D pour tester.
            "paint": {
                "fill-extrusion-color": "#f1f5f9", // Gris clair
                "fill-extrusion-height": 6, // Hauteur par d√©faut (6 m√®tres)
                "fill-extrusion-base": 0,
                "fill-extrusion-opacity": 0.9,
                "fill-extrusion-vertical-gradient": true
            }
        });

        // --- INTERACTIVIT√â (Popup au clic) ---
        map.on('click', 'parcelles-lines', (e) => {
            // R√©cup√®re les propri√©t√©s de l'√©l√©ment cliqu√©
            const props = e.features[0].properties;
            
            // Construit le contenu HTML de la popup
            let content = "<strong>Informations :</strong><br>";
            // Boucle sur toutes les propri√©t√©s disponibles pour tout afficher
            for (const key in props) {
                content += `${key}: ${props[key]}<br>`;
            }

            new maplibregl.Popup()
                .setLngLat(e.lngLat)
                .setHTML(content)
                .addTo(map);
        });

        // Change le curseur en "main" au survol
        map.on('mouseenter', 'parcelles-lines', () => map.getCanvas().style.cursor = 'pointer');
        map.on('mouseleave', 'parcelles-lines', () => map.getCanvas().style.cursor = '');
    });

    // ----------------------------------------------------------------
    // 4. FONCTION DE BASCULE (TOGGLE)
    // ----------------------------------------------------------------
    function toggleLayer(layerId, btnId) {
        // V√©rifie si la couche existe
        if (!map.getLayer(layerId)) return;

        const visibility = map.getLayoutProperty(layerId, 'visibility');
        const btn = document.getElementById(btnId);
        const checkbox = btn.querySelector('input');

        if (visibility === 'visible' || visibility === undefined) {
            map.setLayoutProperty(layerId, 'visibility', 'none');
            btn.classList.remove('active');
            checkbox.checked = false;
        } else {
            map.setLayoutProperty(layerId, 'visibility', 'visible');
            btn.classList.add('active');
            checkbox.checked = true;
        }
    }
</script>

</body>
</html>
